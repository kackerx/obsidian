# MVCC

## sumup

![[Pasted image 20221109122826.png|700]]
- 每次对记录进行改动, 都是记录一条undo日志, 每条undo也有roll_pointer指向早起版本

## readView 视图

> 对于读未提交直接读取最新记录, 对于串形化加锁访问, 对于读已提交和可重复读需要判断当前事务哪个版本可见, 所以有了视图的概念

| -              | -                                                                           |
| -------------- | --------------------------------------------------------------------------- |
| m_ids          | 生成readview时当前系统活跃的读写事务的==事务id==列表                        |
| min_trx_id     | 生成readview时当前系统活跃的读写事务的最小==事务id==, 也就是==m_ids==最小值 |
| max_trx_id     | 生成readview时当前系统应该分配给下一个事务的==id==值                        |
| creator_trx_id | 生成该readView的事务==id==                                                                            |

- 如果访问版本的trxid与视图中的creator_trx_id相同, 说明访问的是自己事务修改过的, 可以访问
- 如果访问版本的trxid小于视图中的min_trx_id, 说明该记录事务在当前readview生成前已提交, 可以访问
- 如果访问版本的trxid大于或等于视图中的max_trx_id, 说明该记录事务在readview生成后开启, 不可以访问
- 如果访问版本的trxid在min和max之间, 判断trxid是否在m_ids中
       在说明事务还是活跃, 不可访问, 不在说明事务已提交, 可以访问
- 如果某版本记录对当前事务不可见, 顺着版本链找, 直到最后一个版本

## 生成时机

### 读已提交 --- 每次读取前都会生成一个ReadView

### 可重复读 --- 在第一次读取时生成一个ReadView

& 复用第一次读时生成的ReadView, 所以当前可重复读事务只能读到第一次读的值



