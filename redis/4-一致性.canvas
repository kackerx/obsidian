{
	"nodes":[
		{"id":"70bae91622aa3c17","x":-700,"y":-440,"width":600,"height":460,"type":"text","text":"## 缓存一致性\n\n![[Pasted image 20230324141700.png]]\n\n```ad-tips\n删除缓存和更新数据库两个操作需要原子性\n- 如果先更新, 后删除失败, 缓存失效前会一直不一致\n- 如果先删除, 后更新失败, 读旧的db值重写缓存, 起码db和cache一致\n```"},
		{"id":"97948c4155b59383","x":-40,"y":-440,"width":680,"height":460,"type":"text","text":"## 解决方案\n\n- 消息队列缓存要更新的值, 如果删除缓存后更新失败, 读mq重复消费\n\n- 延迟双删, 线程A更新完成后开goroutine去sleep后再删一次, 以防止线程B在线程A更新完成前重写缓存, 保证sleep的时间在重写之后"}
	],
	"edges":[]
}