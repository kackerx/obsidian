# ebpf

:::::::::::::::::::::::::::::::::::::::: {.columns shadow=off border=off col-count=2 largest-column=firs}

~~~ad-primary
title: ebpf

1. 可以在内核中运行<mark class="hltr-cyan">沙箱程序</mark>(sandbox), 而无需修改内核源码, 加载内核模块, 重新编译内核
2. 使用高级语言(c), LLVM的eBPF后端编辑包含eBPF指令的ELF文件, 前端(clang)生成程序
3. 后端转换为字节码后, 使用<mark class="hltr-blue">bpf()</mark>系统调用加载bpf程序, JIT将字节码编译进CPU架构, 将程序附加到内核对象上, 对象发生事件时触发程序的执行(如网络接口收发报文)
4. 等于Hook
~~~

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::columnbreak
:::

![[Pasted image 20240105181518.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

## eBPF Map

:::::::::::::::::::::::::::::::::::::::: {.columns shadow=off border=off col-count=2 largest-column=firs}

~~~ad-success
title: map

1. 通用的数据结构, 用于沟通交流用户空间 <--> 内核空间
~~~

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::columnbreak
:::

![[Pasted image 20240105182601.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

## 网络数据收发原理

:::::::::::::::::::::::::::::::::::::::: {.columns shadow=off border=off col-count=2 largest-column=firs}

~~~ad-danger
title:  

1. 数据包到达物理网卡(RX FIFO), 通过<mark class="hltr-blue">DMA</mark>到内存, 内存指的是网卡的接收的<mark class="hltr-grey">Ring Buffer</mark>
2. 拷贝成一个个的<mark class="hltr-blue">sk_buffer</mark>
3. 触发硬中断, 通知CPU, 来数据了, CPU根据注册的中断函数, 中断函数调用驱动, 驱动禁用网卡的中断, 目的下次来数据直接处理, 不再通知CPU硬中断
4. 弥补硬中断处理时间问题, 需要启动一个<mark class="hltr-grey">软中断</mark>
5. 数据单元的<mark class="hltr-cyan">sk_buffer</mark>交给我们的协议栈处理, 实际上就是交给网络层和传输层
6. 去掉ip和tcp层头后, CPU把数据copy到用户空间的应用程序
~~~

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::columnbreak
:::

![[Pasted image 20240105183346.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::: {.columns shadow=off border=off col-count=2 largest-column=firs}

![[Pasted image 20240105184845.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::columnbreak
:::

![[Pasted image 20240105184858.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
