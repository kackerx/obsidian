:::::::::::::::::::::::::::::::::::::::: {.columns shadow=off border=off col-count=2 largest-column=firs}

~~~ad-tips
title: try

- 完成业务检查, 确保一致性
- 预留必要资源, 确保隔离性
- 标记为中间状态(<mark class="hltr-blue">待提交</mark>)
~~~

</br>

~~~ad-grey
title: confirm

- 真正的执行业务逻辑 (更新订单状态<mark class="hltr-cyan">已提交</mark>, 真正执行扣减库存)
- 不做任何业务逻辑检查, 直接持久化到db
- 直接Try阶段预留的业务资源
~~~

</br>

~~~ad-bug
title: cancel

- 释放Try的资源
- 恢复数据库中的数据状态
~~~

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::columnbreak
:::

![[Pasted image 20240701172057.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

## ex

:::::::::::::::::::::::::::::::::::::::: {.columns shadow=off border=off col-count=2 largest-column=firs}

~~~ad-primary
title: try

- 订单服务: 支付中
- 库存服务: 冻结库存, 将sku的数量写入到单独的冻结字段, 同时真正数量减去该冻结字段
- 积分服务: 增加的积分写到预增加积分字段而不是直接增加
- 仓储服务: 出库单状态『未知』而不是直接生成
~~~

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::columnbreak
:::

![[Pasted image 20240701174933.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::: {.columns shadow=off border=off col-count=2 largest-column=firs}

~~~ad-grey
title: confirm

- try的全部执行成功后, 一般这部分由tcc事务框架执行
- 订单服务: 支付成功
- 库存服务: 冻结字段减去提交订单的数量
- 积分服务: 积分字段增加预增加积分字段的数量
- 仓储服务: 更新『已创建』
~~~

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::columnbreak
:::

![[Pasted image 20240701175309.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::::::::: {.columns shadow=off border=off col-count=2 largest-column=firs}

~~~ad-danger
title: cancel

- 订单服务: 已取消
- 库存服务: 冻结字段减去数量, 库存字段加上数量
- 积分服务: 预增加积分字段减去数量
- 仓储服务: 已取消
~~~

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::columnbreak
:::

![[Pasted image 20240701175530.png|666]]

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
