# Raft

## ov
````col
```col-md
- 服务器节点身份<mark style="background: #FFB8EBA6;">跟随者</mark>, <mark style="background: #FF5582A6;">候选人</mark>, <mark style="background: #FFB86CA6;">领导者</mark>
- 跟随者: 接收和处理领导者的消息, 领导者心跳超时时主动推选自己为候选人
- 候选人: 将向其他节点发送请求投票的RPC消息, 通知其他节点投票, 多数票晋升leader
- 领导者: 霸道总裁以我为准, 处理写请求, 管理日志复制, 发送心跳信息通知其他节点我还活着不要选举
- 初始状态每个节点都是跟随者
```

![[Pasted image 20230410142715.png|555]]
````
## 选举
````col
```ad-tips
title: 通讯
- 请求投票(RequestVote)RPC, 候选人选举期间通知各节点投票
- 日志复制(AppendEntries)RPC, 领导者发起, 用来复制日志和提供心跳
```

```ad-quote
title: 任期

- 跟随者等待领导者心跳超时, 推举自己为候选人时增加自己任期号
- 节点发现自己的任期编号比其他节点小, 会更新自己的编号为较大值
- 如果候选者或者领导者发现自己的任期编号比其他节点小, 立即恢复为跟随者状态
- 节点接收到一个较小的任期编号的请求, 会直接拒绝(屏蔽往届的任期RPC请求)
```
````
````col
```ad-note
title: 规则

- 领导者周期性的发送心跳(不包含日志项的日志复制RPC消息)
- 指定时间内跟随者没有收到心跳, 推举自己为候选人, 发起选举
- 一个任期内, 领导者会一直任期, 直到它自身宕机或网络延迟
- 每个节点只会对一个任期编号投出一张票, <mark style="background: #FFB8EBA6;">先来先服务原则</mark>, 
- 任期编号相同时, 日志完整性高的跟随者拒绝投票给日志完整性低的候选人(看节点最后一条日志的编号大小)
```

```ad-info
title: 随机超时

- 节点超时时间随机, 以保证多节点不会同一时刻发起选举, 导致的选票瓜分而选举失败
```
````
## 日志
````col
- 日志项包含, 索引, 任期编号, 客户端指令

```col-md
![[Pasted image 20230410172446.png|555]]
```
````

### 日志复制
````col
```col-md
~~~ad-tips
- 领导者根据客户端请求, 创建一个新日志项, 附加到本地日志中
- 通过日志复制RPC消息(AppendEntries), 将新的日志项复制到其他节点
- 复制到<mark style="background: #FFB8EBA6;">大多数节点</mark>时, 领导者将日志项提交到状态机
- 执行结果返回客户端
- 跟随者收到心跳信息, 或新的日志复制RPC消息后, 发现领导者已经提交了某条日志项, 自己还没提交, 那么跟随者提交本地状态机
~~~
```

![[Pasted image 20230410180619.png]]
````

### 日志一致性
````col
```col-md
~~~ad-tips
- <mark style="background: #FFB8EBA6;">PreLogEntry</mark>: 当前复制的日志项的前一条索引值
- <mark style="background: #FF5582A6;">PreLogTerm</mark>: 当前复制的日志项的前一条任期值
- 领导者通过日支复制RPC消息, 发送最新日志项给追随者
- 追随者中找不到PreLogEntry和PreLogTerm的日志项拒绝接收这个新的日志项, 返回失败
- 领导者就知道该追随者日志不一致, 发送给追随者递减的日志项PreLogEntry和PreLogTerm
- 直至找到一条日志项追随者也存在, 说明这一项之前的是一致的, 之后的会被领导者通过日志复制RPC更新并覆盖之后的项
~~~
```

![[Pasted image 20230410185748.png|555]]
````

