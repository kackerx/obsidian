# 基于本地消息表的最终一致性

## sumup

![[Pasted image 20221103150119.png|700]]

- 由一个mq来解耦, 子服务分别ack后服务才commit
- 问题: 订单服务和mq通讯的网络抖动, 延迟问题: ==本地消息表==

## 消息表

![[Pasted image 20221103151056.png|700]]

- 重复定时扫描表发送, 要保证消息的重复性投递处理

![[Pasted image 20221108012702.png|700]]
![[Pasted image 20221108012825.png||700]]
- 订单系统入库且写入消息表(正在处理), 本地事务
- 订单系统启动定时任务每分钟向库存系统发送正在处理订单消息
- 库存系统处理完毕通知回调, 订单系统修改消息表为处理完毕
- 中间各种失败都是重发, 保证接口的幂等性